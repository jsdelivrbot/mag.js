//////////////////////////////////
//MagJS
//////////////////////////////////
/**!
 * @name mag.js - Copyright (c) 2013, 2014 Michael Glazer
 * @description MagnumJS core code library
 * @author Michael Glazer
 * @date 4/14/14
 * @plunker - http://embed.plnkr.co/ZqpuhSsnMPcCNz9vufay/preview
 * @version 0.1 - Alpha - 0.2.1
 * @license MIT https://github.com/magnumjs/mag.js/blob/master/LICENSE
 * @link https://github.com/magnumjs
 */
"use strict";!function(a,b){var c="warn";window.log=function(){var a=[].shift.apply(arguments),b=Array.prototype.slice.call(arguments);a==c&&console&&console[c](b.join(","))},a.reserved=["__requires","__instance"],a.aspect={injectors:[],namespace:null,add:function(b,c,d){a.aspect.injectors.push({type:b,name:c,fun:d})},attach:function(){for(var b in a.aspect.injectors){var c=a.aspect.injectors[b];a.aspect[c.type]&&a.aspect[c.type](c.name,c.fun)}},around:function(b,c){var d=a.aspect.namespace;for(var e in a.aspect.namespace)"function"==typeof d[e]&&e.match(b)&&function(a,b,d){d[b]=function(){return c.call(d,{fn:a,fnName:b,arguments:arguments})}}(d[e],e,d)},before:function(b,c){a.aspect.around(b,function(b){return c.apply(a.aspect.namespace,b.arguments),a.aspect.next(b)})},after:function(b,c){a.aspect.around(b,function(b){var d=a.aspect.next(b);return c.apply(a.aspect.namespace,b.arguments),d})},next:function(b){return b.fn.apply(a.aspect.namespace,b.arguments)}},a.inject=function(b){a.aspect.namespace=b,a.aspect.attach()},a.module=function(c,d){function h(a){var b;if("function"!=typeof a){b=a,mfun=b.pop();var c=mfun.toString(),d=c.substring(c.indexOf("{")+1,c.lastIndexOf("}"));a=new Function(b.join(),d)}return[a,b]}log("info","module name:"+c),this.modules=this.modules||{};var e=this.modules[c];if(e&&(!d||d&&0==d.length))return e;var f={namespace:b,dependencies:{},waiting:[],findArgs:function(a){if("function"==typeof a){var b=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,c=/,/,e=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,f=a.toString().replace(e,""),g=f.match(b),h=g[1].split(c).map(function(a){return a.trim()});return h}},getInstance:function(a){return this.instances=this.instances||{},this.instances[this.namespace]=this.instances[this.namespace]||{},this.instances[this.namespace][a]?this.instances[this.namespace][a]:void 0},setInstance:function(a,b){this.instances[this.namespace][a]=b},process:function(a,b,c){function f(a,b,c){function d(){return a.apply(c||this,b)}return d.prototype=a.prototype,new d}var d=this.findArgs(a),e=b||d;if(c){var g=this.getInstance(c);return g?g:(g=f(a,this.getArrayDependencies(e)),this.setInstance(c,g),g)}if(this.isRegistered(e))a.apply(a,this.getArrayDependencies(e));else{var h={target:a,args:e};this.waiting.push(h)}},isRegistered:function(a){var b=!0;log("info","isRegistered args:",a);for(var c in a){var d=a[c];if(!this.getDependencies()[d]){log("warn","Dependency not registered when called:",d),b=!1;break}}return b},getArrayDependencies:function(a){var b=this.getDependencies(),c=this;return a.map(function(a){return b[a]&&b[a].__requires&&(log("info","this dependency has dependencies: "+a),log("info","requires: "+b[a].__requires)),b[a]&&b[a].__instance?c.process(b[a],null,a):b[a]})},getDependencies:function(a){return this.dependencies[a||this.namespace]||{}},register:function(a,b,c){var d=this.findArgs(b);log("info",a+" requires "+d),this.getDependencies()[a]=b,c&&(this.getDependencies()[a].__instance=c),this.getDependencies()[a].__requires=d,this.service()},service:function(){for(var a in this.waiting){var b=this.waiting[a];this.isRegistered(b.args)&&(b.target.apply(b.target,this.getArrayDependencies(b.args)),delete this.waiting[a])}}};if(f.namespace=c,f.dependencies[c]={},d){var g=function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];if(this.modules[e]){var g=this.modules[e];b.push(g);for(var h in g.services)f.register(h,g.services[h],1);for(var i in g.factories)f.register(i,g.factories[i]())}}}.bind(this);g(d)}return this.modules[c]=new function(){this.name=c,this.config=function(a){f.process(a)},this.service=function(a,b){this.services=this.services||{},this.services[a]=this.services[a]||b,f.register(a,b,1)},this.factory=function(a,b){this.factories=this.factories||{},this.factories[a]=this.factories[a]||b,f.register(a,this.factories[a]())},this.control=function(a,b){this.controls=this.controls||{},f.register("Scope",this.getScope(a));var c=h(b);this.fire("mag.control.process.begin",[a]),f.process(c[0],c[1]),this.fire("mag.control.process.end",[a])},this.getScope=function(a){return this.controls=this.controls||{},this.controls[a]=this.controls[a]||{}},this.observers={},this.on=function(a,b){for(a=a.split(/\s+/);var eventName=a.shift();)this.observers[eventName]||(this.observers[eventName]=[]),this.observers[eventName].push(b)},this.fire=function(a,b){if(this.observers[a])for(var c=0;c<this.observers[a].length;c++)this.observers[a][c].apply(this,b)},a.inject(this)}}}(window.mag={}),function(){var c=Object.prototype.toString;mag.template.serve=function(a){mag.aspect.next(a);var b=a.arguments[0],c=this.getScope(b),d=this;this.on("propertyChanged",function(){mag.template.parse(d,b,c)}),mag.template.parse(d,b,c)},mag.template.parse=function(a,b,d){log("info","template parse start"+b);var e=document.getElementById(b);a.fire("mag.template.begin",[b]),this.templates=this.templates||{},this.templates[b]=this.templates[b]||e?e:0,this.template=this.templates[b];var e=this.template;if(e&&""!=this.template){var f=e.parentNode;e.parentNode.removeChild(e);var g=mag.reserved;this.applyVar=function(a,b,c){if(a.nodeType){var d=a.getElementsByClassName(b),e=d.length;for(1>e&&this.setVar(a,b,c);e--;)this.setVar(a,b,c,d,e)}},this.setVar=function(a,b,c,d,e){var f="function"==typeof c[b]?c[b].call(this):c[b];this.pattern=this.pattern||new RegExp("\\[\\[(.*?)\\]\\]","g"),a.innerHTML=a.innerHTML.replace(this.pattern,function(a,c){return f&&b==c&&-1===g.indexOf(b)?f:a}),f&&d&&-1===g.indexOf(b)&&""==d[e].innerText&&(d[e].innerText=f)},this.applyVars=function(a,b){for(var c in b)this.applyVar(a,c,b)},this.parser=function(a,b){for(var d in b)if("[object Array]"===c.call(b[d])){var e=a.getElementsByClassName(d);if(!e[0])return;for(var f=e[0].cloneNode(!0),g=b[d],h=0;h<g.length;h++){var i=f.cloneNode(!0);g[h],this.applyVars(i,g[h]),e[0].parentNode.appendChild(i)}e[0].parentNode.removeChild(e[0])}else this.applyVar(a,d,b)},this.parser(e,d),a.fire("mag.template.end",[b]),f.appendChild(e)}},mag.aspect.add("around","control",mag.template.serve)}(window.mag=window.mag||{},mag.template={}),Object.prototype.watch||Object.defineProperty(Object.prototype,"__watch",{enumerable:!1,configurable:!0,writable:!1,value:function(a,b){var c=this[a],d=c,e=function(){return d},f=function(e){c=d;var f=this;return b.call(f,a,c,e),d};delete this[a]&&(Object.defineProperty?Object.defineProperty(this,a,{get:e,set:f}):Object.prototype.__defineGetter__&&Object.prototype.__defineSetter__&&(Object.prototype.__defineGetter__.call(this,a,e),Object.prototype.__defineSetter__.call(this,a,f)))}}),function(a,b){mag.watch.throttle=function(a,b,c){b||(b=250);var d,e;return function(){var f=c||this,g=+new Date,h=arguments;d&&d+b>g?(clearTimeout(e),e=setTimeout(function(){d=g,a.apply(f,h)},b)):(d=g,a.apply(f,h))}},mag.watch.serve=function(a){var c=this;this.getScope(a),this.controls.__watch(a,mag.watch.throttle(function(a,d,e){JSON.stringify(d)!==JSON.stringify({})&&JSON.stringify(d)!==JSON.stringify({ignoreKey:b})&&c.fire("propertyChanged",[a,d,e])},250,c))},mag.aspect.add("before","control",mag.watch.serve)}(window.mag=window.mag||{},mag.watch={});
