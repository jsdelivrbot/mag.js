//////////////////////////////////
//MagJS
//////////////////////////////////
/**!
 * @name mag.js - Copyright (c) 2013, 2014 Michael Glazer
 * @description MagnumJS core code library
 * @requires - jQuery http://www.jquery.com
 * @author Michael Glazer
 * @date 4/29/2014
 * @version Alpha - 0.2.29
 * @license MIT https://github.com/magnumjs/mag.js/blob/master/LICENSE
 * @link https://github.com/magnumjs/mag.js
 */
!function(e,t){var n="warn";window.log=function(){var e=[].shift.apply(arguments),t=Array.prototype.slice.call(arguments);e==n&&console&&console[n](t.join(","))},e.reserved=["__requires","__instance"],e.aspect={injectors:[],namespace:null,add:function(t,n,r){e.aspect.injectors.push({type:t,name:n,fun:r})},attach:function(){for(var t in e.aspect.injectors){var n=e.aspect.injectors[t];e.aspect[n.type]&&e.aspect[n.type](n.name,n.fun)}},around:function(t,n){var r=e.aspect.namespace;for(var i in e.aspect.namespace)"function"==typeof r[i]&&i.match(t)&&!function(e,t,r){r[t]=function(){return n.call(r,{fn:e,fnName:t,arguments:arguments})}}(r[i],i,r)},before:function(t,n){e.aspect.around(t,function(t){return n.apply(e.aspect.namespace,t.arguments),e.aspect.next(t)})},after:function(t,n){e.aspect.around(t,function(t){var r=e.aspect.next(t);return n.apply(e.aspect.namespace,t.arguments),r})},next:function(t){return t.fn.apply(e.aspect.namespace,t.arguments)}},e.inject=function(t){e.aspect.namespace=t,e.aspect.attach()},e.module=function(n,r){function i(e){var t;if("function"!=typeof e){t=e;var n=t.pop(),r=""+n,i=r.substring(r.indexOf("{")+1,r.lastIndexOf("}"));e=Function(t.join(),i)}return[e,t]}log("info","module name:"+n),this.modules=this.modules||{};var s=this.modules[n];if(s&&(!r||r&&0!=r.length))return s;var a={namespace:t,dependencies:{},waiting:[],findArgs:function(e){if("function"==typeof e){var t=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,n=/,/,r=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,i=(""+e).replace(r,""),s=i.match(t),a=s[1].split(n).map(function(e){return e.trim()});return a}},getInstance:function(e){return this.instances=this.instances||{},this.instances[this.namespace]=this.instances[this.namespace]||{},this.instances[this.namespace][e]?this.instances[this.namespace][e]:t},setInstance:function(e,t){this.instances[this.namespace][e]=t},process:function(e,t,n,r,i){function s(e,t,n){function r(){return e.apply(n||this,t)}return r.prototype=e.prototype,new r}var a=this.findArgs(e),o=t||a;if(n){var c=this.getInstance(n);return c?c:(c=s(e,this.getArrayDependencies(o)),this.setInstance(n,c),c)}if(this.isRegistered(o)){var h=e.apply(r,this.getArrayDependencies(o));h&&h.done&&h.done(function(){r.controls[i]})}else{var p={target:e,args:o};this.waiting.push(p)}},isRegistered:function(e){var t=!0;log("info","isRegistered args:",e);for(var n in e){var r=e[n];if(!this.getDependencies()[r]){log("info","Dependency not registered when called:",r),t=!1;break}}return t},getArrayDependencies:function(e){var t=this.getDependencies(),n=this;return e.map(function(e){return t[e]&&t[e].__requires&&(log("info","this dependency has dependencies: "+e),log("info","requires: "+t[e].__requires)),t[e]&&t[e].__instance?n.process(t[e],null,e):t[e]})},getDependencies:function(e){return this.dependencies[e||this.namespace]||{}},register:function(e,t,n){var r=this.findArgs(t);log("info",e+" requires "+r),this.getDependencies()[e]=t,n&&(this.getDependencies()[e].__instance=n),this.getDependencies()[e].__requires=r,this.service()},service:function(){for(var e in this.waiting){var t=this.waiting[e];this.isRegistered(t.args)&&(t.target.apply(t.target,this.getArrayDependencies(t.args)),delete this.waiting[e])}}};if(a.namespace=n,a.dependencies[n]={},r){var o=function(e){for(var t=[],n=0,r=e.length;r>n;n++){var i=e[n];if(this.modules[i]){var s=this.modules[i];t.push(s);for(var o in s.services)a.register(o,s.services[o],1);for(var c in s.factories)a.register(c,s.factories[c]())}}}.bind(this);o(r)}return this.modules[n]=new function(){this.name=n,this.config=function(e){a.process(e)},this.service=function(e,t){this.services=this.services||{},this.services[e]=this.services[e]||t,a.register(e,t,1)},this.factory=function(e,t){this.factories=this.factories||{},this.factories[e]=this.factories[e]||t,a.register(e,this.factories[e]())},this.control=function(e,t){this.controls=this.controls||{},a.register("Scope",this.getScope(e));var n=i(t);this.fire("mag.control.process.begin",[e]),a.process(n[0],n[1],0,this,e),this.fire("mag.control.process.end",[e])},this.getScope=function(e){return this.controls=this.controls||{},this.controls[e]=this.controls[e]||{}},this.observers={},this.on=function(e,t){e=e.split(/\s+/);for(var n;n=e.shift();)this.observers[n]||(this.observers[n]=[]),this.observers[n].push(t)},this.fire=function(e,t){if(this.observers[e])for(var n=0;n<this.observers[e].length;n++)this.observers[e][n].apply(this,t)},e.inject(this)}}}(window.mag={}),Object.prototype.watch||Object.defineProperty(Object.prototype,"__watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,t,n){var r=this[e],i=r,s=function(){return i=n.call(this,e,i)},a=function(n){return t.call(this,e,r,n),n};delete this[e]&&(Object.defineProperty?Object.defineProperty(this,e,{get:s,set:a}):Object.prototype.__defineGetter__&&Object.prototype.__defineSetter__&&(Object.prototype.__defineGetter__.call(this,e,s),Object.prototype.__defineSetter__.call(this,e,a)))}}),function(e,t,n){e.watch.throttle=function(e,t,n){t||(t=50);var r,i;return function(){var s=n||this,a=+new Date,o=arguments;r&&r+t>a?(clearTimeout(i),i=setTimeout(function(){r=a,e.apply(s,o)},t)):(r=a,e.apply(s,o))}},e.watch.serve=function(e){function t(e,t){return t==={}||JSON.stringify(e)===JSON.stringify({})||JSON.stringify(e)===JSON.stringify({ignoreKey:n})?!0:!1}var r=this;this.getScope(e);var i="__requires",s=function(e,n,s){log("info","set-"+e,n,s),t(n,s,i)||(log("info",e,n,s),r.fire("propertyChanged",[e,n,s]))},a=function(e,t){return log("info","get"+e,t),r.fire("propertyAccessed",arguments),t};this.controls.__watch(e,s,a),this._bind=function(e,t){var n=this;$(e).on("change input click propertyChange",function(){return n[t]=e.val(),!0})}},e.aspect.add("before","control",e.watch.serve)}(window.mag=window.mag||{},mag.watch={}),function(e,t,n,r){function s(e){this.selectorDataKey=h,this.nodeContext=e||r}function a(e){var t=e.childNodes,n=[];for(i=0;i<t.length;i+=1)t[i].nodeType===c&&n.push(t[i]);return n}function o(e,t,n){var r=" "+e.className+" ",i="data-"+n||"bind",s=e.attributes;if(s.length>0)for(var a=0,o=s.length;o>a;a++)if(0===e.attributes[a].nodeName.indexOf(i)){e.attributes[a].nodeName.indexOf(i);var c=s[a].nodeName.substr(i.length+1);return e.setAttribute("mg-event",c),!0}return e.id===t||r.indexOf(" "+t+" ")>-1||e.name===t||e.nodeName.toLowerCase()===t.toLowerCase()||e.getAttribute(i)===t}var c=1,h="bind";e.domElement=function(e){var t=new s(e);return t},s.prototype.getSelectorDataKey=function(e){return this.selectorDataKey=e||this.selectorDataKey},s.prototype.findElementsByKey=function(e,t){var n=this.matchingElements(t||this.nodeContext,e);return n},s.prototype.findElementsByKeys=function(e,t){var n=[];for(var r in e){var i=this.matchingElements(t||this.nodeContext,r);if(i){var s={key:r,elements:i};n.push(s)}}return n},s.prototype.matchingElements=function(e,t,n){var r=a(e),i=[],s=t;for(c=0;c<r.length;c+=1)o(r[c],s,this.getSelectorDataKey())&&i.push(r[c]);for(var c=0;c<r.length;c++){var h=this.matchingElements(r[c],t,!0);if(h&&h.length>0){i=i.concat(h);break}}return n||i.length?i:!1}}(window.mag=window.mag||{},mag.domElement={},window,document),function(e,t){t.server=function(t,n){var r=e.domElement(e.render.template);r.getSelectorDataKey("event");var i=this;for(var s in t){var a=t[s];if("function"==typeof a){var o=r.findElementsByKey(s);if(o[0]&&!o[0]._hasevent){var c=o[0].getAttribute("mg-event");if(c){var h=function(e){"function"==typeof a&&(a.bind(t).call(this,e),i.controls[n])}.bind(this);o[0].parentNode._hasevent||(o[0].parentNode.addEventListener(c,h,!1),o[0].parentNode._hasevent=!0)}}}}},t.serve=function(t){var n=this.getScope(t);this.on("mag.render.end",function(){e.uiEvent.server.call(this,n,t)})},e.aspect.add("after","control",t.serve)}(window.mag=window.mag||{},mag.uiEvent={}),function(){var e=Object.prototype.toString;mag.render.serve=function(e){var t=e.arguments[0],n=mag.render.preParser(this,t);if(n){mag.aspect.next(e);var r=this.getScope(t),i=this;this.on("propertyChanged",mag.watch.throttle(function(){this.count=this.count+1||0,mag.render.parse(i,t,r)})),this.on("propertyAccessed",mag.watch.throttle(function(){this.count=this.count+1||0,mag.render.parse(i,t,r)})),mag.render.parse(i,t,r)}},mag.render.preParser=function(e,t){log("info","template parse start"+t);var n=document.getElementById(t);e.fire("mag.render.begin",[t]),this.templates=this.templates||{},this.templates[t]=this.templates[t]||n?n:0,this.template=this.templates[t];var n=this.template;if(!n||""==this.template)return!1;var r=n.parentNode;return n.parentNode.removeChild(n),this.node=n,this.parent=r,{node:n,parent:r}},mag.render.parse=function(t,n,r){if(this.node){var i=this.node,s=this.parent,a=mag.reserved;this.applyVar=function(e,t,n){if(e.nodeType){var r=e.getElementsByClassName(t),i=r.length;for(1>i&&this.setVar(e,t,n);i--;)this.setVar(e,t,n,r,i)}},this.setVar=function(e,t,n,r,i){function s(e,t,n){var r="function"==typeof e[t]?e[t].call(n||this):e[t];return r}this.pattern=this.pattern||RegExp("\\[\\[(.*?)\\]\\]","g"),e.innerHTML=e.innerHTML.replace(this.pattern,function(e,r){return t==r&&-1===a.indexOf(t)?s(n,t):e}),r&&-1===a.indexOf(t)&&""==r[i].innerText&&(r[i].innerText=s(n,t,this))},this.applyVars=function(e,t){for(var n in t)this.applyVar(e,n,t)},this.parser=function(t,n){for(var r in n)if("[object Array]"===e.call(n[r])){var i=t.getElementsByClassName(r);if(!i[0])return;for(var s=i[0].cloneNode(!0),a=n[r],o=0;o<a.length;o++){var c=s.cloneNode(!0);a[o],this.applyVars(c,a[o]),i[0].parentNode.appendChild(c)}i[0].parentNode.removeChild(i[0])}else this.applyVar(t,r,n)},this.parser(i,r),t.fire("mag.render.end",[n]),s.appendChild(i)}},mag.aspect.add("around","control",mag.render.serve)}(window.mag=window.mag||{},mag.render={});
