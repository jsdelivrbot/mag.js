//////////////////////////////////
//MagJS
//////////////////////////////////
/**!
 * @name mag.js - Copyright (c) 2013, 2014 Michael Glazer
 * @description MagnumJS core code library
 * @author Michael Glazer
 * @date 4/14/14
 * @plunker - http://embed.plnkr.co/ZqpuhSsnMPcCNz9vufay/preview
 * @version 0.1 - Alpha - 0.2.1
 * @license MIT https://github.com/magnumjs/mag.js/blob/master/LICENSE
 * @link https://github.com/magnumjs
 */
!function(e,t){var s="warn";window.log=function(){var e=[].shift.apply(arguments),t=Array.prototype.slice.call(arguments);e==s&&console&&console[s](t.join(","))},e.reserved=["__requires","__instance"],e.aspect={injectors:[],namespace:null,add:function(t,s,n){e.aspect.injectors.push({type:t,name:s,fun:n})},attach:function(){for(var t in e.aspect.injectors){var s=e.aspect.injectors[t];e.aspect[s.type]&&e.aspect[s.type](s.name,s.fun)}},around:function(t,s){var n=e.aspect.namespace;for(var i in e.aspect.namespace)"function"==typeof n[i]&&i.match(t)&&!function(e,t,n){n[t]=function(){return s.call(n,{fn:e,fnName:t,arguments:arguments})}}(n[i],i,n)},before:function(t,s){e.aspect.around(t,function(t){return s.apply(e.aspect.namespace,t.arguments),e.aspect.next(t)})},after:function(t,s){e.aspect.around(t,function(t){var n=e.aspect.next(t);return s.apply(e.aspect.namespace,t.arguments),n})},next:function(t){return t.fn.apply(e.aspect.namespace,t.arguments)}},e.inject=function(t){e.aspect.namespace=t,e.aspect.attach()},e.module=function(s,n){function i(e){var t;if("function"!=typeof e){t=e,mfun=t.pop();var s=""+mfun,n=s.substring(s.indexOf("{")+1,s.lastIndexOf("}"));e=Function(t.join(),n)}return[e,t]}log("info","module name:"+s),this.modules=this.modules||{};var r=this.modules[s];if(r&&(!n||n&&0==n.length))return r;var a={namespace:t,dependencies:{},waiting:[],findArgs:function(e){if("function"==typeof e){var t=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,s=/,/,n=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,i=(""+e).replace(n,""),r=i.match(t),a=r[1].split(s).map(function(e){return e.trim()});return a}},getInstance:function(e){return this.instances=this.instances||{},this.instances[this.namespace]=this.instances[this.namespace]||{},this.instances[this.namespace][e]?this.instances[this.namespace][e]:t},setInstance:function(e,t){this.instances[this.namespace][e]=t},process:function(e,t,s){function n(e,t,s){function n(){return e.apply(s||this,t)}return n.prototype=e.prototype,new n}var i=this.findArgs(e),r=t||i;if(s){var a=this.getInstance(s);return a?a:(a=n(e,this.getArrayDependencies(r)),this.setInstance(s,a),a)}if(this.isRegistered(r))e.apply(e,this.getArrayDependencies(r));else{var c={target:e,args:r};this.waiting.push(c)}},isRegistered:function(e){var t=!0;log("info","isRegistered args:",e);for(var s in e){var n=e[s];if(!this.getDependencies()[n]){log("warn","Dependency not registered when called:",n),t=!1;break}}return t},getArrayDependencies:function(e){var t=this.getDependencies(),s=this;return e.map(function(e){return t[e]&&t[e].__requires&&(log("info","this dependency has dependencies: "+e),log("info","requires: "+t[e].__requires)),t[e]&&t[e].__instance?s.process(t[e],null,e):t[e]})},getDependencies:function(e){return this.dependencies[e||this.namespace]||{}},register:function(e,t,s){var n=this.findArgs(t);log("info",e+" requires "+n),this.getDependencies()[e]=t,s&&(this.getDependencies()[e].__instance=s),this.getDependencies()[e].__requires=n,this.service()},service:function(){for(var e in this.waiting){var t=this.waiting[e];this.isRegistered(t.args)&&(t.target.apply(t.target,this.getArrayDependencies(t.args)),delete this.waiting[e])}}};if(a.namespace=s,a.dependencies[s]={},n){var c=function(e){for(var t=[],s=0,n=e.length;n>s;s++){var i=e[s];if(this.modules[i]){var r=this.modules[i];t.push(r);for(var c in r.services)a.register(c,r.services[c],1);for(var o in r.factories)a.register(o,r.factories[o]())}}}.bind(this);c(n)}return this.modules[s]=new function(){this.name=s,this.config=function(e){a.process(e)},this.service=function(e,t){this.services=this.services||{},this.services[e]=this.services[e]||t,a.register(e,t,1)},this.factory=function(e,t){this.factories=this.factories||{},this.factories[e]=this.factories[e]||t,a.register(e,this.factories[e]())},this.control=function(e,t){this.controls=this.controls||{},a.register("Scope",this.getScope(e));var s=i(t);this.fire("mag.control.process.begin",[e]),a.process(s[0],s[1]),this.fire("mag.control.process.end",[e])},this.getScope=function(e){return this.controls=this.controls||{},this.controls[e]=this.controls[e]||{}},this.observers={},this.on=function(e,t){for(e=e.split(/\s+/);eventName=e.shift();)this.observers[eventName]||(this.observers[eventName]=[]),this.observers[eventName].push(t)},this.fire=function(e,t){if(this.observers[e])for(var s=0;s<this.observers[e].length;s++)this.observers[e][s].apply(this,t)},e.inject(this)}}}(window.mag={});!function(){var e=Object.prototype.toString;mag.template.serve=function(e){mag.aspect.next(e);var t=e.arguments[0],n=this.getScope(t),s=this;this.on("propertyChanged",function(){mag.template.parse(s,t,n)}),mag.template.parse(s,t,n)},mag.template.parse=function(t,n,s){log("info","template parse start"+n);var i=document.getElementById(n);t.fire("mag.template.begin",[n]),this.templates=this.templates||{},this.templates[n]=this.templates[n]||i?i:0,this.template=this.templates[n];var i=this.template;if(i&&""!=this.template){var r=i.parentNode;i.parentNode.removeChild(i);var a=mag.reserved;this.applyVar=function(e,t,n){if(e.nodeType){var s=e.getElementsByClassName(t),i=s.length;for(1>i&&this.setVar(e,t,n);i--;)this.setVar(e,t,n,s,i)}},this.setVar=function(e,t,n,s,i){var r="function"==typeof n[t]?n[t].call(this):n[t];this.pattern=this.pattern||RegExp("\\[\\[(.*?)\\]\\]","g"),e.innerHTML=e.innerHTML.replace(this.pattern,function(e,n){return r&&t==n&&-1===a.indexOf(t)?r:e}),r&&s&&-1===a.indexOf(t)&&""==s[i].innerText&&(s[i].innerText=r)},this.applyVars=function(e,t){for(var n in t)this.applyVar(e,n,t)},this.parser=function(t,n){for(var s in n)if("[object Array]"===e.call(n[s])){var i=t.getElementsByClassName(s);if(!i[0])return;for(var r=i[0].cloneNode(!0),a=n[s],o=0;o<a.length;o++){var c=r.cloneNode(!0);a[o],this.applyVars(c,a[o]),i[0].parentNode.appendChild(c)}i[0].parentNode.removeChild(i[0])}else this.applyVar(t,s,n)},this.parser(i,s),t.fire("mag.template.end",[n]),r.appendChild(i)}},mag.aspect.add("around","control",mag.template.serve)}(window.mag=window.mag||{},mag.template={});Object.prototype.watch||Object.defineProperty(Object.prototype,"__watch",{enumerable:!1,configurable:!0,writable:!1,value:function(e,t){var n=this[e],s=n,i=function(){return s},r=function(i){n=s;var r=this;return t.call(r,e,n,i),s};delete this[e]&&(Object.defineProperty?Object.defineProperty(this,e,{get:i,set:r}):Object.prototype.__defineGetter__&&Object.prototype.__defineSetter__&&(Object.prototype.__defineGetter__.call(this,e,i),Object.prototype.__defineSetter__.call(this,e,r)))}}),function(e,t){mag.watch.throttle=function(e,t,n){t||(t=250);var s,i;return function(){var r=n||this,a=+new Date,o=arguments;s&&s+t>a?(clearTimeout(i),i=setTimeout(function(){s=a,e.apply(r,o)},t)):(s=a,e.apply(r,o))}},mag.watch.serve=function(e){var n=this;this.getScope(e),this.controls.__watch(e,mag.watch.throttle(function(e,s,i){JSON.stringify(s)!==JSON.stringify({})&&JSON.stringify(s)!==JSON.stringify({ignoreKey:t})&&n.fire("propertyChanged",[e,s,i])},250,n))},mag.aspect.add("before","control",mag.watch.serve)}(window.mag=window.mag||{},mag.watch={});
