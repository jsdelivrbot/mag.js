/*
Mag.JS v0.8.6
http://github.com/magnumjs/mag.js
(c) Michael Glazer
License: MIT
*/
!function(n,e,t,r){function o(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(n){if(""!==n.id)return'id("'+n.id+'")';if(n===t.body)return n.tagName;var e=0;if(n.parentNode)for(var r=n.parentNode.childNodes,o=0;o<r.length;o++){var l=r[o];if(l===n)return i(n.parentNode)+"/"+n.tagName+"["+(e+1)+"]";1===l.nodeType&&l.tagName===n.tagName&&e++}}function l(n){var e=i(n);n.queryCache&&delete n.queryCache,n.parentNode.removeChild(n),p[e+"-config"]&&p[e+"-config"].configContext&&"function"==typeof p[e+"-config"].configContext.onunload&&p[e+"-config"].configContext.onunload(p[e+"-config"].configContext,n,JSON.parse(p[e]),e),delete p[e];for(var t in p)0===t.indexOf(e)&&delete p[t]}function a(n){return(n=n&&parseInt(n.split("[").pop().slice(0,-1)))?parseInt(n)-1:0}function u(n,e,t){var r,a,s;if(n){null==e&&(e={_text:""});var d=f(n);if(s=o(e)){if(m[t]&&0===d.length&&(m[t].parent.insertAdjacentHTML("beforeend",m[t].node),d=f(m[t].parent.children),"object"==typeof e[0]&&(e[0].__magnum__=d[0].__key=0)),0===d.length)return;for(a=d[0].parentNode,m[t]||(m[t]={node:d[0].cloneNode(!0).outerHTML,parent:a});d.length<e.length;){var g=d.length;m[t]?(a.insertAdjacentHTML("beforeend",m[t].node),r=a.lastChild):r=d[0].cloneNode(!0),"object"==typeof e[g]&&(e[g].__magnum__=g,r.__key=g++),d.push(r),a&&a.appendChild(r)}if(d.length>e.length)if(0==e.length||"object"!=typeof e[0])for(;d.length>e.length;)r=d.pop(),(a=r.parentNode)&&l(r);else d=d.filter(function(n){return 0==e.filter(function(e){return e.__magnum__==n.__key}).length?(l(n),!1):!0})}for(t=0;t<d.length;t++)r=i(d[t]),s?!d[t]||p[r]&&p[r]===JSON.stringify(e[t])||(u(d[t],e[t]),p[r]=JSON.stringify(e[t]),d[t].queryCache&&delete d[t].queryCache):c(d[t],e);return n}}function c(n,e){var t;if("function"!=typeof e){if("object"!=typeof e)return c(n,{_text:e});for(var a in e){var f=e[a];f===r?f="":null===f&&-1===["onunload"].indexOf(a)&&h(n,a).forEach(function(n){l(n)}),"_"===a[0]&&"__magnum__"!=a&&(t=t||{},t[a.substr(1)]=f)}var d=i(n);t&&s(n,t);var g=0;for(a in e)if(f=e[a],"_"!==a[0]){if(t=h(n,a),"function"==typeof f&&"fun"==f.type)try{f=f()}catch(v){}o(f)&&(t=h(n,"$"+a)),u(t,f,d+"/"+a),g++}}}function f(n){var e;if(null==n.length&&(n=[n]),!o(n)){e=[];for(var t=0;t<n.length;t+=1)n[t]&&e.push(n[t]);n=e}return n}function s(t,r){var o=i(t),l=!1,u=a(o);p[o]&&p[o]===JSON.stringify(r)&&(l=!0),t._events=t._events||[];for(var c in r)if("text"!==c&&"html"!==c)if(0==c.indexOf("on")){if(-1===t._events.indexOf(c)||y){var f=function(e,t,r,o){try{return e.call(t,o,r,t)}finally{n.redraw()}}.bind(null,r[c],t,u);t[c]=f,t._events.push(c)}}else if("config"==c){f=!0,p[o+"-config"]?f=!1:p[o+"-config"]={};var s=p[o+"-config"].configContext=p[o+"-config"].configContext||{};e.push(function(n,e){return function(){return n.apply(n,e)}}(r[c],[t,f,s,u]))}else f={key:c,cache:l,value:r[c],node:t},n.hook("attributes",c,f),f.change&&(c=f.key,r[c]=f.value),l||(null===r[c]?t.removeAttribute(c):t.setAttribute(c,""+r[c]));l||(d(t,r.text),g(t,r.html),p[o]=JSON.stringify(r),t.queryCache&&delete t.queryCache)}function d(n,e){var t,r;if(i(n),n&&null!=e){if(!r){r=[];for(var o=0;o<n.childNodes.length;o+=1)t=n.childNodes[o],t.nodeType===v&&r.push(t)}for(;n.firstChild;)n.removeChild(n.firstChild);for("input"===n.nodeName.toLowerCase()?n.setAttribute("value",""+e):n.appendChild(n.ownerDocument.createTextNode(""+e)),o=0;o<r.length;o+=1)n.appendChild(r[o])}}function g(n,e){n&&null!=e&&(n.innerHTML=e)}function h(n,e,t){for(var r=n.childNodes,o=[],i=0;i<r.length;i+=1)r[i].nodeType===v&&o.push(r[i]);if(r=[],i=e,!n.queryCache||!n.queryCache[e]||"$"===e[0]){n.queryCache=(n.queryCache||{})[e]=[];var l="$"===e[0];"$"===i[0]&&(i=i.substr(1));for(var a=0;a<o.length;a+=1){var u=o[a],c=i,f=" "+u.className+" ";(u.id===c||-1<f.indexOf(" "+c+" ")||u.name===c||u.nodeName.toLowerCase()===c.toLowerCase()||u.getAttribute("data-bind")===c)&&r.push(o[a])}if(!r.length||l)for(a=0;a<o.length&&(r=r.concat(h(o[a],e,!0)),!r.length||l);a++);!t&&!r.length,n.queryCache[e]=r}return n.queryCache[e]}var v=1,p=[],m={},p=[],y=!1;n.fill={fill:u,find:h,clear:function(){y=!0},unclear:function(){y=!1},configs:e},window.mag=n}(window.mag||{},[],document),function(n){var e={modules:[],promises:[],deferreds:[],controllers:[],elements:[],getController:function(n){return new n.controller},submodule:function(n,e){var t=function(e){return(n.controller||function(){}).apply(this,e)}.bind({},e);return t.$original=n.controller,t={controller:t,view:function(t){1<arguments.length&&(e=e.concat([].slice.call(arguments,1)));var r=n.view.apply(n,e?[t].concat(e):[t]);return e[0]&&null!=e[0].key&&(r.attrs.key=e[0].key),r}},e[0]&&null!=e[0].key&&(t.attrs={key:e[0].key}),t},getArgs:function(n){return e.modules[n].controller&&e.modules[n].controller.$$args?[e.controllers[n]].concat(e.modules[n].controller.$$args):[e.controllers[n]]}};n.mod=e}(window.mag||{}),function(n){function e(n,e,t){var r=(e.getArgs(t),e.modules[t]);e=e.controllers[t];try{r.view(n,e)}catch(o){}}function t(n,e){Object.observe(n,function(r){r.forEach(function(r){"object"==typeof n[r.name]&&t(n[r.name],e)}),e.apply(this,arguments)})}var r={roots:[],templates:{},cache:{},callOnload:function(n){for(var e,t=0;e=n.controllers[t];t++)e.onload&&!e.called&&(e.onload.call(null,n.elements[t]),e.called=1)},callConfigs:function(n){for(var e=0,t=n.length;t>e;e++)n[e]()}},o=[];r.redraw=function(n,e,t){n=n||r.module||{},this.fun=this.fun||u(function(){e.configs.splice(0,e.configs.length),r.doLoop(n,e,t)}),this.fun()},r.doLoop=function(e,t,o){for(var i=0;r.roots[i];i++)if(n.running=!0,e.controllers[i]&&r.innerLoop(e,t,i,o)&&(e.deferreds[i][2]({_html:e.elements[i].innerHTML}),e.deferreds[i][0])){var l=e.deferreds[i][1];delete e.elements[l],e.modules[l],e.controllers[l],e.promises[l],e.deferreds[l]}t.unclear()},r.clear=function(n,e,t){-1!==n&&o[n]&&t.clear()},r.innerLoop=function(n,t,i,l){var a=n.elements[i],u=n.getArgs(i);return o[i]&&o[i]===JSON.stringify(u[0])?!1:(e(a,n,i),o[i]=JSON.stringify(u[0]),r.setupWatch(l,u,t,a,i,n),t.fill(a,u[0]),r.callConfigs(t.configs),r.callOnload(n),!0)};var i;r.doWatch=function(t,l,a,u,c,f){f!=i&&(i=f,n.running=!0,c=u.getArgs(a),o[a]&&o[a]===JSON.stringify(c[0])||(e(l,u,a),o[a]=JSON.stringify(c[0]),t.fill(l,c[0]),r.callConfigs(t.configs),n.running=!1))},r.setupWatch=function(n,e,o,i,l,a){t(e[0],function(n){u(r.doWatch.bind(null,o,i,l,a,n))()})};var l=window.cancelAnimationFrame||window.clearTimeout,a=window.requestAnimationFrame||window.setTimeout,u=function(n,e){var t,r,o=e||16;return function(){if(+new Date-t>o||a===window.requestAnimationFrame){r>0&&l(r);var e=arguments;r=a(function(){t=+new Date;var r=[].slice.call(arguments).concat([].slice.call(e));n.apply(this,r)},o)}else{t=+new Date;var i=[].slice.call(arguments).concat([].slice.call(e));n.apply(this,i),r=a(function(){r=null},o)}}};n.render=r}(window.mag||{}),function(n,e){function t(e){var t=function(){return arguments.length&&(e=arguments[0],n.redraw()),e};return t.type="fun",t.toJSON=function(){return e},t}function r(e,t){var o=n.prop(t);return e.then(o),o.then=function(n,o){return r(e.then(n,o),t)},o}var o=n.mod,i=n.render,l=n.fill,a=n.watch,u={}.toString,c=n.running=!1;n.redraw=function(){c||(c=!0,i.redraw(o||i.module||{},l,a),c=!1)},n.withProp=function(n,e){return function(t){t=t||event,t=t.currentTarget||this,e(n in t?t[n]:t.getAttribute(n))}},n.prop=function(n){return(null!=n&&"[object Object]"===u.call(n)||"function"==typeof n)&&"function"==typeof n.then?r(n):t(n)};var f={attributes:[]};n.hookin=function(n,e,t){f[n].push({context:{},handler:t,key:e})},n.hook=function(n,e,t,r){for(var o in f[n])t.changed=!1,f[n][o].key==e&&(r=JSON.stringify({v:t.value,k:t.key}),f[n][o].handler.call(f[n][o].context,t),r!==JSON.stringify({v:t.value,k:t.key})&&(t.change=!0))};var s=[];n.module=function(t,a,u,c){var f=i.roots.indexOf(t);u&&!u.retain&&i.clear(f,t,l),(0>f||c)&&(f=i.roots.length);for(var d,g=!1,h={preventDefault:function(){g=!0}},v=0;d=s[v];v++)d.handler(h),d.controller.onunload=null;if(g)for(v=0;d=s[v];v++)d.controller.onunload=d.handler;else s=[];return g?void 0:(t=e.getElementById(t))?(i.roots[f]=t.id,a.view?(a=o.submodule(a,[u||{}]),u=o.getController(a,t,l),o.controllers[f]=u,u.onunload&&s.push({controller:u,handler:u.onunload}),o.modules[f]=a,o.elements[f]=c?t.cloneNode(!0):t,o.promises[f]=new Promise(function(){o.deferreds[f]=arguments}.bind(null,c,f)),n.redraw(),u.onload&&!n.running&&i.callOnload(o),r(o.promises[f],{_html:o.elements[f].innerHTML})):Error("module requires a view")):Error("invalid node")}}(window.mag||{},document);
